<app-navbar [title]="'Watch'"></app-navbar>

<main
  class="flex w-full min-h-screen overflow-x-hidden max-w-7xl mx-auto gap-8"
>
  <section *ngIf="loading" class="text-center py-10 w-full">
    <p class="text-lg">Loading video...</p>
  </section>

  <section *ngIf="error" class="text-center py-10 w-full">
    <p class="text-lg font-semibold">⚠️ Failed to load video</p>
  </section>

  <section
    *ngIf="!loading && !error && video"
    class="flex flex-col lg:flex-row gap-8 w-full"
  >
    <div class="flex-grow max-w-4xl flex flex-col">
      <!-- Use the new VideoActionBarComponent -->
      <app-video-action-bar
        [videoTitle]="video.title"
        [isSaved]="isSaved"
        [loadingSavedVideo]="loadingSavedVideo"
        (addToPlaylist)="addToPlaylist($event)"
        (toggleSaved)="toggleSaved()"
      ></app-video-action-bar>

      <div class="overflow-hidden">
        <ng-container *ngIf="true; else defaultPlayer">
          <app-vidstack-player
            [videoUrl]="videoUrl"
            [posterUrl]="thumbnailUrl"
            [vttUrl]="storyboardVttUrl"
            [vttChapters]="chapterFileUrl"
          ></app-vidstack-player>
        </ng-container>

        <ng-template #defaultPlayer>
          <app-default-video-player
            [videoUrl]="videoUrl"
            [posterUrl]="thumbnailUrl"
          ></app-default-video-player>
        </ng-template>
      </div>

      <div class="flex flex-col gap-6 p-5">
        <!-- Use the new VideoMetadataPanelComponent -->
        <app-video-metadata-panel
          [videoDurationSeconds]="video.durationSeconds"
          [videoUploadedAt]="video.uploadedAt"
          [videoResolution]="video.resolution"
        ></app-video-metadata-panel>

        <!-- Use the TagManagementPanelComponent (already renamed) -->
        <app-tag-management-panel
          [videoId]="video.videoId"
          [currentTags]="video.tags"
          (tagsUpdated)="video.tags = $event"
        ></app-tag-management-panel>

        <app-chapter-edit-panel
          [videoId]="video.videoId"
        ></app-chapter-edit-panel>
      </div>
    </div>

    <aside class="w-full lg:w-80 mt-10 lg:self-start p-5">
      <!-- Use the SimilarVideosPanelComponent (already renamed) -->
      <app-similar-videos-panel
        [currentVideoId]="videoId!"
        (navigateToVideo)="navigateToVideo($event)"
      ></app-similar-videos-panel>
    </aside>
  </section>
</main>

<app-playlist-modal
  [visible]="playlistModalVisible"
  [playlists]="playlists"
  (close)="closePlaylistModal($event)"
></app-playlist-modal>
