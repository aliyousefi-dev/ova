import{a as O}from"./chunk-3N5CP3KU.js";import"./chunk-NZXTMSRA.js";import{a as j}from"./chunk-ALENSEJ7.js";import{a as q}from"./chunk-3RIWJDGJ.js";import{a as b}from"./chunk-U6XIDZYM.js";import{d as m,e as $}from"./chunk-6TJZC2SC.js";import{b as P,c as _}from"./chunk-JAD4QJUG.js";import"./chunk-3IUBWZWC.js";import{c as C,f as F,g as R,m as I}from"./chunk-VUE4JCUK.js";import{a as p}from"./chunk-YH4K2B5K.js";import{I as M,T as N,a as k,j as T,m as A,n as u,p as D,r as l,t as v}from"./chunk-LRNDPFQA.js";import{a as x,e as f}from"./chunk-JKOY2XUY.js";function Q(n){try{return new Intl.DisplayNames(navigator.languages,{type:"language"}).of(n)??null}catch{return null}}var K=n=>`dash-${N(n)}`,w=class{#e;#i;#t=null;#a=new Set;#r=null;config={};get instance(){return this.#t}constructor(t,e){this.#e=t,this.#i=e}setup(t){this.#t=t().create();let e=this.#m.bind(this);for(let i of Object.values(t.events))this.#t.on(i,e);this.#t.on(t.events.ERROR,this.#w.bind(this));for(let i of this.#a)i(this.#t);this.#i.player.dispatch("dash-instance",{detail:this.#t}),this.#t.initialize(this.#e,void 0,!1),this.#t.updateSettings(x({streaming:{text:{defaultEnabled:!1,dispatchForManualRendering:!0},buffer:{fastSwitchEnabled:!0}}},this.config)),this.#t.on(t.events.FRAGMENT_LOADING_STARTED,this.#S.bind(this)),this.#t.on(t.events.FRAGMENT_LOADING_COMPLETED,this.#E.bind(this)),this.#t.on(t.events.MANIFEST_LOADED,this.#b.bind(this)),this.#t.on(t.events.QUALITY_CHANGE_RENDERED,this.#v.bind(this)),this.#t.on(t.events.TEXT_TRACKS_ADDED,this.#y.bind(this)),this.#t.on(t.events.TRACK_CHANGE_RENDERED,this.#T.bind(this)),this.#i.qualities[b.enableAuto]=this.#x.bind(this),v(this.#i.qualities,"change",this.#k.bind(this)),v(this.#i.audioTracks,"change",this.#A.bind(this)),this.#r=M(this.#d.bind(this))}#s(t){return new l(K(t.type),{detail:t})}#d(){if(!this.#i.$state.live())return;let t=new j(this.#f.bind(this));return t.start(),t.stop.bind(t)}#f(){if(!this.#t)return;let t=this.#t.duration()-this.#t.time();this.#i.$state.liveSyncPosition.set(isNaN(t)?1/0:t)}#m(t){this.#i.player?.dispatch(this.#s(t))}#n=null;#h={};#g(t){let e=this.#n?.[m.native],i=(e?.track).cues;if(!e||!i)return;let r=this.#n.id,a=this.#h[r]??0,o=this.#s(t);for(let c=a;c<i.length;c++){let h=i[c];h.positionAlign||(h.positionAlign="auto"),this.#n.addCue(h,o)}this.#h[r]=i.length}#y(t){if(!this.#t)return;let e=t.tracks,i=[...this.#e.textTracks].filter(a=>"manualMode"in a),r=this.#s(t);for(let a=0;a<i.length;a++){let o=e[a],c=i[a],h=`dash-${o.kind}-${a}`,d=new $({id:h,label:o?.label??o.labels.find(y=>y.text)?.text??(o?.lang&&Q(o.lang))??o?.lang??void 0,language:o.lang??void 0,kind:o.kind,default:o.defaultTrack});d[m.native]={managed:!0,track:c},d[m.readyState]=2,d[m.onModeChange]=()=>{this.#t&&(d.mode==="showing"?(this.#t.setTextTrack(a),this.#n=d):(this.#t.setTextTrack(-1),this.#n=null))},this.#i.textTracks.add(d,r)}}#T(t){let{mediaType:e,newMediaInfo:i}=t;if(e==="audio"){let r=this.#i.audioTracks.getById(`dash-audio-${i.index}`);if(r){let a=this.#s(t);this.#i.audioTracks[p.select](r,!0,a)}}}#v(t){if(t.mediaType!=="video")return;let e=this.#i.qualities[t.newQuality];if(e){let i=this.#s(t);this.#i.qualities[p.select](e,!0,i)}}#b(t){if(this.#i.$state.canPlay()||!this.#t)return;let{type:e,mediaPresentationDuration:i}=t.data,r=this.#s(t);this.#i.notify("stream-type-change",e!=="static"?"live":"on-demand",r),this.#i.notify("duration-change",i,r),this.#i.qualities[b.setAuto](!0,r);let a=this.#t.getVideoElement(),o=this.#t.getTracksForTypeFromManifest("video",t.data),c=[...new Set(o.map(s=>s.mimeType))].find(s=>s&&R(a,s)),h=o.filter(s=>c===s.mimeType)[0],d=this.#t.getTracksForTypeFromManifest("audio",t.data),y=[...new Set(d.map(s=>s.mimeType))].find(s=>s&&F(a,s));if(d=d.filter(s=>y===s.mimeType),h.bitrateList.forEach((s,g)=>{let E={id:s.id?.toString()??`dash-bitrate-${g}`,width:s.width??0,height:s.height??0,bitrate:s.bandwidth??0,codec:h.codec,index:g};this.#i.qualities[p.add](E,r)}),A(h.index)){let s=this.#i.qualities[h.index];s&&this.#i.qualities[p.select](s,!0,r)}d.forEach((s,g)=>{let V=s.labels.find(L=>navigator.languages.some(B=>L.lang&&B.toLowerCase().startsWith(L.lang.toLowerCase())))||s.labels[0],U={id:`dash-audio-${s?.index}`,label:V?.text??(s.lang&&Q(s.lang))??s.lang??"",language:s.lang??"",kind:"main",mimeType:s.mimeType,codec:s.codec,index:g};this.#i.audioTracks[p.add](U,r)}),a.dispatchEvent(new l("canplay",{trigger:r}))}#w(t){let{type:e,error:i}=t;switch(i.code){case 27:this.#L(i);break;default:this.#l(i);break}}#S(){this.#o>=0&&this.#c()}#E(t){t.mediaType==="text"&&requestAnimationFrame(this.#g.bind(this,t))}#o=-1;#L(t){this.#c(),this.#t?.play(),this.#o=window.setTimeout(()=>{this.#o=-1,this.#l(t)},5e3)}#c(){clearTimeout(this.#o),this.#o=-1}#l(t){this.#i.notify("error",{message:t.message??"",code:1,error:t})}#x(){this.#u("video",!0);let{qualities:t}=this.#i;this.#t?.setQualityFor("video",t.selectedIndex,!0)}#u(t,e){this.#t?.updateSettings({streaming:{abr:{autoSwitchBitrate:{[t]:e}}}})}#k(){let{qualities:t}=this.#i;!this.#t||t.auto||!t.selected||(this.#u("video",!1),this.#t.setQualityFor("video",t.selectedIndex,t.switch==="current"),C&&(this.#e.currentTime=this.#e.currentTime))}#A(){if(!this.#t)return;let{audioTracks:t}=this.#i,e=this.#t.getTracksFor("audio").find(i=>t.selected&&t.selected.id===`dash-audio-${i.index}`);e&&this.#t.setCurrentTrack(e)}#p(){this.#c(),this.#n=null,this.#h={}}onInstance(t){return this.#a.add(t),()=>this.#a.delete(t)}loadSource(t){this.#p(),u(t.src)&&this.#t?.attachSource(t.src)}destroy(){this.#p(),this.#t?.destroy(),this.#t=null,this.#r?.(),this.#r=null}},S=class{#e;#i;#t;constructor(t,e,i){this.#e=t,this.#i=e,this.#t=i,this.#a()}#a(){return f(this,null,function*(){let t={onLoadStart:this.#r.bind(this),onLoaded:this.#s.bind(this),onLoadError:this.#d.bind(this)},e=yield z(this.#e,t);if(T(e)&&!u(this.#e)&&(e=yield Y(this.#e,t)),!e)return null;if(!window.dashjs.supportsMediaSource()){let i="[vidstack] `dash.js` is not supported in this environment";return this.#i.player.dispatch(new l("dash-unsupported")),this.#i.notify("error",{message:i,code:4}),null}return e})}#r(){this.#i.player.dispatch(new l("dash-lib-load-start"))}#s(t){this.#i.player.dispatch(new l("dash-lib-loaded",{detail:t})),this.#t(t)}#d(t){let e=q(t);this.#i.player.dispatch(new l("dash-lib-load-error",{detail:e})),this.#i.notify("error",{message:e.message,code:4,error:e})}};function Y(e){return f(this,arguments,function*(n,t={}){if(!T(n)){if(t.onLoadStart?.(),J(n))return t.onLoaded?.(n),n;if(H(n)){let i=n.MediaPlayer;return t.onLoaded?.(i),i}try{let i=(yield n())?.default;if(H(i))return t.onLoaded?.(i.MediaPlayer),i.MediaPlayer;if(i)t.onLoaded?.(i);else throw Error("");return i}catch(i){t.onLoadError?.(i)}}})}function z(e){return f(this,arguments,function*(n,t={}){if(u(n)){t.onLoadStart?.();try{if(yield _(n),!D(window.dashjs.MediaPlayer))throw Error("");let i=window.dashjs.MediaPlayer;return t.onLoaded?.(i),i}catch(i){t.onLoadError?.(i)}}})}function J(n){return n&&n.prototype&&n.prototype!==Function}function H(n){return n&&"MediaPlayer"in n}var W="https://cdn.jsdelivr.net",G=class extends O{$$PROVIDER_TYPE="DASH";#e=null;#i=new w(this.video,this.ctx);get ctor(){return this.#e}get instance(){return this.#i.instance}static supported=I();get type(){return"dash"}get canLiveSync(){return!0}#t=`${W}/npm/dashjs@4.7.4/dist/dash.all.min.js`;get config(){return this.#i.config}set config(t){this.#i.config=t}get library(){return this.#t}set library(t){this.#t=t}preconnect(){u(this.#t)&&P(this.#t)}setup(){super.setup(),new S(this.#t,this.ctx,t=>{this.#e=t,this.#i.setup(t),this.ctx.notify("provider-setup",this);let e=k(this.ctx.$state.source);e&&this.loadSource(e)})}loadSource(t,e){return f(this,null,function*(){if(!u(t.src)){this.removeSource();return}this.media.preload=e||"",this.appendSource(t,"application/x-mpegurl"),this.#i.loadSource(t),this.currentSrc=t})}onInstance(t){let e=this.#i.instance;return e&&t(e),this.#i.onInstance(t)}destroy(){this.#i.destroy()}};export{G as DASHProvider};
